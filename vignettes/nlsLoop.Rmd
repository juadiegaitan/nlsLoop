---
title: "nlsLoop"
author: "Daniel Padfield"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{nlsLoop}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

__nlsLoop__ is a simple R package that gives a more reproducible and reliable method for fitting individual non-linear regression fits over levels of a factor within a data frame. This procedure is commonly done using __nlme::nlsList__, but this function can only use one set of parameter values. Consequently, some levels of the factor fail to converge on the correct parameter value simply because of the starting values. __nlsLoop__ allows multiple starting values for each parameter, therefore allowing for more parameter space to be explored when model fitting. The best model is chosen based on AIC score.

This document provides an introduction into this one key use of __nlsLoop__, and also demonstrates its potential for producing predictions around each fit and exploratory plotting.

## An example non-linear model fit

This vignette will use data from a dataset of thermal response curves for photosynthesis and respiration of the aquatic phytoplankton _Chlorella vulgaris_ (Padfield _et. al_ 2016). This data represents the rate of photosynthesis and respiration at different short-term, assay temperatures (16 ºC to 46 ºC) and was done in triplicate at 5 growth temperatures (20  ºC, 23 ºC, 27 ºC, 30 ºC and 33 ºC) after both 10 (acclimation) and 100 (adaptation) generations of growth.

This gives 60 curves in total. These responses generally follow a unimodal response and there are various models that have been used to fit to the data. A very recent overview of these can be found [here](http://onlinelibrary.wiley.com/doi/10.1002/ece3.3576/epdf) and the authors also released an R package which contains many of these [models](https://cran.r-project.org/web/packages/temperatureresponse/index.html) (Low-Decarie _et al._ 2017).

I will demonstrate how the model can be fitted with the Sharpe-Schoolfield model of the form:

A detailed explanation of the model can be found here (Padfield _et. al_ 2016). So we can load the data in and then write a function to run the model.



The data we shall use for this tutorial are a bunch of thermal performance curves showing the relationship between metabolic rates and temperature in the aquatic alga, _Chlorella vulgaris_<sup>[2]</sup>.

So enough talking, lets load in the data and have an initial look at the data.

```{r load in data and look, tidy=TRUE}
data('Chlorella_TRC')

head(Chlorella_TRC)
```

As you can see, and read about in the [paper](http://onlinelibrary.wiley.com/doi/10.1111/ele.12545/full) (__YES, THIS IS A PLUG__), we have rates of metabolism for both photosynthesis and respiration across 5 different growth temperatures after both 10 (acclimation) and 100 (adaptation) generations of growth, so we can have a go at an initial plot accordingly...

```{r first plot, fig.width=12, fig.height=9}
ggplot(Chlorella_TRC) +
  geom_point(aes(temp, ln.rate, col = growth.temp), shape = 21, size = 2, alpha = 0.5) +
  facet_wrap(~flux + process, labeller = labeller(.multi_line = F)) +
  scale_colour_gradient(low = 'blue', high = 'red', 'Growth Temperature') +
  theme_bw(base_size = 16, base_family = 'Helvetica') +
  ylab('log Metabolic rate') +
  xlab('Assay temperature (ºC)')
```

The data follows a classic unimodal thermal performance curve and can be modelled using a modified version of the Sharpe-Schoolfield model<sup>[3]</sup>. A function characterising the model is provided in the package as `schoolfield.high()`. This is more about the fitting of non-linear curves than the model so that's as in depth as I will go here!

The data has 60 separate curves and `id_col = curve_id`. So lets fit the model!

#### 3. Run nlsLoop

`nlsLoop::nlsLoop()` uses `minpack.lm::nlsLM()` to fit each individual curve allows addiitional arguments such as `lower` and `na.action` accordingly. The best fit for each factor level is determined using AIC scores and if the best fit does not change for 100 "tries" then it will move onto the next level of the factor.

```{r nlsLoop, message=FALSE, warning=FALSE, results='hide'}
fits <- nlsLoop(ln.rate ~ schoolfield.high(ln.c, Ea, Eh, Th, temp = K, Tc = 20),
                     data = Chlorella_TRC,
                     tries = 500,
                     id_col = 'curve_id',
                     param_bds = c(-10, 10, 0.1, 2, 0.5, 5, 285, 330),
                     r2 = 'Y',
                     supp.errors = 'Y',
                     AICc = 'Y',
                     na.action = na.omit,
                     lower = c(ln.c=-10, Ea=0, Eh=0, Th=0))

```

__WARNING: This may take quite a while depending on how good your parameter boundaries are!__

The result of this returns an `nlsLoop` object that is made up of `params` which has all of our parameter values for each individual fit and `predictions` which is a high resolution predicted dataframe to allow for a smooth curve on a plot (which we will come to later).

These can be accessed simply using `fits$params` or `fits$predictions`.

```{r}
head(fits$params)
```

Having all of these in a single `nlsLoop` object allows a simple plotting method to assess how good our fits to the data are.  One of the best ways to assess non-linear model is by __ACTUALLY LOOKING__ at how well every model fits its respective raw data.

#### 4. Plotting

Firstly lets have a look at a single level of `curve_id`, a function called `plot_id_nlsLoop()` allows this.

```{r first fit plot, fig.height=6, fig.width=8}
plot_id_nlsLoop(raw_data = Chlorella_TRC, param_data = fits, id = '1')
```

Not a bad fit... Further to this, `plot_all_nlsLoop()` will produce a pdf with each plot on a new sheet.

```{r pdf fits, eval=FALSE}
plot_all_nlsLoop('path/of/where/you/want/to/save/me.pdf', raw_data = Chlorella_TRC, param_data = fits)
```

#### 5. Exploratory analysis

We can now edit some of the dataframes to look at the curves split by the treatments within the dataset and explore how the parameter values change across the treatments.

For example we can plot all the curves split by respiration, photosynthesis and acclimatory or adaptive timescales.

```{r data wrangling, fig.width=12, fig.height=9, eval = FALSE}

# select treatment columns from original dataset
treatments <- select(Chlorella_TRC, c(curve_id, process, growth.temp, flux))
# keep unique combinations of treatments
treatments <- unique(treatments[,colnames(treatments)])

# bind treatments to predictions and parameter dataframe
fits$params <- merge(fits$params, treatments, by = 'curve_id')
fits$predictions <- merge(fits$predictions, treatments, by = 'curve_id')

# plot every curve
ggplot() +
  geom_point(aes(K, ln.rate, col = growth.temp), shape = 21, size = 2, alpha = 0.25, Chlorella_TRC) +
  geom_line(aes(K, ln.rate, col = growth.temp, group = curve_id), linetype = 2, alpha = 0.5, fits$predictions) +
  facet_wrap(~flux + process, labeller = labeller(.multi_line = F)) +
  scale_colour_gradient(low = 'blue', high = 'red', 'Growth Temperature') +
  theme_bw(base_size = 16, base_family = 'Helvetica') +
  ylab('log Metabolic rate') +
  xlab('Assay temperature (ºC)')

```

We can also start having a quick look at any differences between parameters...

```{r parameter plots, fig.height=8, fig.width=10, eval = FALSE}

gather(fits$params, 'parameter', 'value', c(ln.c, Ea, Eh, Th)) %>%
  ggplot(.) +
  geom_point(aes(growth.temp, value, col = flux, shape = process), fill = 'white', size = 2, position = position_dodge(width = 0.25)) +
  facet_wrap(~ parameter, scales = 'free_y') +
  scale_color_manual(values = c('green4', 'black')) +
  scale_shape_manual(values = c(21, 24)) +
  theme_bw(base_size = 16, base_family = 'Helvetica')
  

```

From here we can see that the activation energy (_E~a~_) in the model does not change systematically with growth temperature or whether it has acclimated or adapted to the growth temperature. However a body of work has shown that photosynthesis should be less sensitive to temperature change (a lower _E~a~_) than that of respiration.

```{r Ea plots, fig.height=6, fig.width=8, eval = FALSE}
ggplot(fits$params, aes(flux, Ea)) +
  geom_boxplot(aes(fill = flux, col = flux), outlier.shape = NA, width = 0.5) +
  stat_summary(geom = 'crossbar', fatten = 0, color = 'white', width = 0.5, fun.data = function(x){ return(c(y=median(x), ymin=median(x), ymax=median(x)))}) +
  geom_jitter(aes(flux, Ea, col = flux), shape = 21, fill ='white', width = 0.25, height = 0) +
  theme_bw(base_size = 16, base_family = 'Helvetica') +
  scale_color_manual(values = c('green4', 'black')) +
  scale_fill_manual(values = c('green4', 'black')) +
  ylab('Activation enrrgy (eV)') +
  xlab('Flux')
  

```

And as we can see it looks like we have a difference in the activation energies, with photosynthesis having a lower activation energy than respiration.

So from there we can start exploring our data and formally analysing our parameters! `nlsLoop` allows us to have confidence in our fitting of all the curves and gives us an easy way of plotting and manipulating the data afterwards! 

Happy model fitting. Any comments much appreciated.

### References:
[1] Spiess, A.N. & Neumeyer, N. (2010). An evaluation of R<sup>2</sup> as an inadequate measure for nonlinear models in pharmacological and biochemical research: a Monte Carlo approach. BMC Pharmacology, 10, 6.

[2] Padfield, D., Yvon-durocher, G., Buckling, A., Jennings, S. & Yvon-durocher, G. (2015). Rapid evolution of metabolic traits explains thermal adaptation in phytoplankton. Ecology Letters, 19(2), 133-142.

[3] Schoolfield, R.M., Sharpe, P.J. & Magnuson, C.E. (1981). Non-linear regression of biological temperature-dependent rate models based on absolute reaction-rate theory. J. Theoretical Biology, 88, 719–31.

Vignettes are long form documentation commonly included in packages. Because they are part of the distribution of the package, they need to be as compact as possible. The `html_vignette` output type provides a custom style sheet (and tweaks some options) to ensure that the resulting html is as small as possible. The `html_vignette` format:

- Never uses retina figures
- Has a smaller default figure size
- Uses a custom CSS stylesheet instead of the default Twitter Bootstrap style

## Vignette Info

Note the various macros within the `vignette` section of the metadata block above. These are required in order to instruct R how to build the vignette. Note that you should change the `title` field and the `\VignetteIndexEntry` to match the title of your vignette.

## Styles

The `html_vignette` template includes a basic CSS theme. To override this theme you can specify your own CSS in the document metadata as follows:

    output: 
      rmarkdown::html_vignette:
        css: mystyles.css

## Figures

The figure sizes have been customised so that you can easily put two images side-by-side. 

```{r, fig.show='hold'}
plot(1:10)
plot(10:1)
```

You can enable figure captions by `fig_caption: yes` in YAML:

    output:
      rmarkdown::html_vignette:
        fig_caption: yes

Then you can use the chunk option `fig.cap = "Your figure caption."` in **knitr**.

## More Examples

You can write math expressions, e.g. $Y = X\beta + \epsilon$, footnotes^[A footnote here.], and tables, e.g. using `knitr::kable()`.

```{r, echo=FALSE, results='asis'}
knitr::kable(head(mtcars, 10))
```

Also a quote using `>`:

> "He who gives up [code] safety for [code] speed deserves neither."
([via](https://twitter.com/hadleywickham/status/504368538874703872))
